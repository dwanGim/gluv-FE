name: Setup FEServer

on:
  push:
    branches: [ "main" ]
    
jobs:
  setup-server:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: 서버 설정
        on:
          push:
            branches:
              - main
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }} 
          username: ${{ secrets.AWS_SSH_USER }}
          key: ${{ secrets.AWS_SSH_PRIVATE_KEY }}
          script: 

            jobs:
              deploy:
                runs-on: ubuntu-latest
            
                steps:
                  - name: Checkout Repository
                    uses: actions/checkout@v2
            
                  - name: Install SSH Key
                    run: echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa && chmod 600 ~/.ssh/id_rsa
            
                  - name: Setup SSH Config
                    run: echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config
            
                  - name: Install Dependencies
                    run: sudo apt-get update && sudo apt-get install -y ssh
            
                  - name: Deploy Nginx Configuration
                    run:
                      scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -r ./nginx-config/ ec2-user@$EC2_PUBLIC_IP:~/nginx-config
                      ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ec2-user@$EC2_PUBLIC_IP 'bash -s' < ./nginx-config/setup.sh
            
